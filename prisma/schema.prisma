// Personal Training Client Management System
// Database Schema - MVP Phase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts (both admin and clients)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Will be hashed with bcrypt
  role      Role     @default(CLIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clientProfile        ClientProfile?
  appointmentsAsClient Appointment[] @relation("ClientAppointments")
  appointmentsAsAdmin  Appointment[] @relation("AdminAppointments")
  rpgCharacter         RPGCharacter?
  rpgUserQuests        RPGUserQuest[]
  rpgUserAchievements  RPGUserAchievement[]
  rpgXPLogs            RPGXPLog[]

  @@index([email])
  @@index([role])
}

enum Role {
  ADMIN
  CLIENT
}

// Client profile data (extended info for clients)
model ClientProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Information
  fullName          String
  phone             String
  email             String?
  age               Int?
  gender            String?              // "Male", "Female", "Prefer not to say"
  height            Float?               // Stored in inches (convert from cm if needed)
  heightUnit        String?              // "inches" or "centimeters"
  currentWeight     Float?
  weightUnit        String?              // "pounds" or "kilograms"
  
  // Emergency Contact
  emergencyContact        String?
  emergencyPhone          String?
  emergencyRelationship   String?        // "Spouse", "Parent", "Sibling", "Friend", "Other"
  
  // Health & Medical
  hasMedicalConditions    Boolean?
  medicalConditions       String?        // Description if hasMedicalConditions = true
  isTakingMedications     Boolean?
  medications             String?        // Description if isTakingMedications = true
  hasInjuries             Boolean?
  injuriesDescription     String?        // Description if hasInjuries = true
  hasAllergies            Boolean?
  allergies               String?        // Description if hasAllergies = true
  fitnessLevel            String?        // "Beginner", "Intermediate", "Advanced"
  
  // Fitness History
  hasWorkedOutBefore      Boolean?
  previousExerciseTypes   String?        // Types of exercise done before
  hasHomeEquipment        Boolean?
  homeEquipmentTypes      String?        // Description if hasHomeEquipment = true
  
  // Goals
  primaryGoal             String?        // Main fitness goal
  secondaryGoals          String?        // Additional goals
  targetTimeline          String?        // Timeline for achieving goals
  
  // Lifestyle
  typicalActivityLevel    String?        // "Sedentary", "Light Active", "Active", "Very Active"
  averageSleepHours       Float?
  dietaryRestrictions     String?        // Dietary restrictions or allergies
  
  // Preferences
  exerciseDaysPerWeek     Int?
  preferredWorkoutDays    String?        // Days and times preferred
  sessionsPerMonth        Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([fullName])
}

// Appointment/Session scheduling
model Appointment {
  id        String   @id @default(cuid())
  
  // Who and when
  clientId  String
  client    User     @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)
  
  adminId   String?  // Nullable - not set until admin approves/creates
  admin     User?    @relation("AdminAppointments", fields: [adminId], references: [id])
  
  dateTime  DateTime
  duration  Int      @default(60) // Duration in minutes
  
  // Session Details
  sessionType SessionType @default(ONE_ON_ONE)
  location    String?     // "LA Fitness", "Client Home", "Virtual", etc.
  
  // Status tracking
  status    AppointmentStatus @default(PENDING_APPROVAL)
  
  // Booking metadata
  bookedBy  BookedBy  // Track if client self-booked or admin created
  
  // Communication
  whatsappNotificationSent Boolean @default(false)
  whatsappReminderSent     Boolean @default(false)
  
  // Notes
  notes           String?  // Admin notes about the session
  clientNotes     String?  // Client's notes when booking (reason, preferences, etc.)
  rejectionReason String?  // If admin rejects, optional reason
  
  // Cancellation tracking
  cancelledAt     DateTime?
  cancelReason    String?   // Reason for cancellation
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([adminId])
  @@index([dateTime])
  @@index([status])
  @@index([sessionType])
}

enum AppointmentStatus {
  PENDING_APPROVAL  // Client booked, waiting for admin approval
  CONFIRMED         // Admin approved (or admin created directly)
  COMPLETED         // Session finished
  CANCELLED         // Cancelled by either party
  REJECTED          // Admin declined the booking request
  NO_SHOW           // Client didn't show up
}

enum BookedBy {
  CLIENT  // Client self-booked (needs approval)
  ADMIN   // Admin created directly (auto-confirmed)
}

enum SessionType {
  ONE_ON_ONE      // Standard 1-on-1 training session
  GROUP           // Group training class
  ASSESSMENT      // Initial assessment / consultation
  CHECK_IN        // Progress check-in / weigh-in
}

// ========================================
// RPG GAMIFICATION SYSTEM
// ========================================

// RPG Character (one per client user)
model RPGCharacter {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Progression
  level     Int      @default(1)
  xp        Int      @default(0)
  
  // Stats (0-100 scale)
  strength    Int    @default(0)  // Grows with strength training
  endurance   Int    @default(0)  // Grows with cardio/endurance work
  discipline  Int    @default(0)  // Grows with consistency/streaks
  
  // Streaks
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastWorkoutDate DateTime?
  
  // Avatar customization (JSON config)
  avatarConfig    Json     @default("{}") // Stores body type, colors, accessories, etc.
  
  // Leaderboard visibility
  publicProfile   Boolean  @default(false) // Opt-in to show name on leaderboard
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([level])
  @@index([xp])
}

// Quest templates (reusable quest definitions)
model RPGQuest {
  id          String   @id @default(cuid())
  
  // Quest details
  name        String
  description String
  type        QuestType
  
  // Rewards
  xpReward    Int      @default(0)
  
  // Requirements (JSON for flexibility)
  // Example: {"type": "complete_sessions", "count": 3}
  // Example: {"type": "maintain_streak", "days": 7}
  requirements Json
  
  // Repeatability
  repeatable  Boolean  @default(true)  // Can be completed multiple times
  
  // Availability
  active      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userQuests  RPGUserQuest[]

  @@index([type])
  @@index([active])
}

enum QuestType {
  DAILY       // Refreshes daily
  WEEKLY      // Refreshes weekly (Monday)
  MONTHLY     // Refreshes monthly
  PERSONAL    // Admin-created for specific client
}

// User's active/completed quests
model RPGUserQuest {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  questId   String
  quest     RPGQuest @relation(fields: [questId], references: [id], onDelete: Cascade)
  
  // Progress tracking (JSON for flexibility)
  // Example: {"sessions_completed": 2, "target": 3}
  progress  Json     @default("{}")
  
  // Completion
  completed Boolean  @default(false)
  completedAt DateTime?
  
  // Assignment date (for tracking weekly/daily resets)
  assignedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([questId])
  @@index([completed])
  @@index([assignedAt])
}

// Achievement definitions
model RPGAchievement {
  id          String   @id @default(cuid())
  
  name        String
  description String
  category    AchievementCategory
  
  // Badge display
  badgeIcon   String   // Icon identifier (emoji or image path)
  badgeColor  String   @default("#FFD700") // Hex color
  
  // Unlock criteria (JSON for flexibility)
  // Example: {"type": "reach_level", "level": 10}
  // Example: {"type": "streak_days", "days": 30}
  unlockCriteria Json
  
  // Rarity
  rarity      AchievementRarity @default(COMMON)
  
  active      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userAchievements RPGUserAchievement[]

  @@index([category])
  @@index([rarity])
  @@index([active])
}

enum AchievementCategory {
  MILESTONE    // Level/session milestones
  STREAK       // Consistency achievements
  STRENGTH     // Strength-based PRs
  ENDURANCE    // Cardio/endurance achievements
  SOCIAL       // Referrals, community
  SPECIAL      // Limited-time, unique
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

// User's unlocked achievements
model RPGUserAchievement {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  achievementId String
  achievement   RPGAchievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  unlockedAt    DateTime @default(now())

  @@unique([userId, achievementId]) // Can't unlock same achievement twice
  @@index([userId])
  @@index([achievementId])
}

// XP transaction log (for transparency and debugging)
model RPGXPLog {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount    Int      // XP awarded (can be negative for penalties)
  source    String   // "session_complete", "quest_complete", "streak_bonus", etc.
  
  // Reference to source (session ID, quest ID, etc.)
  referenceId String?
  
  // Optional note
  note      String?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([source])
  @@index([createdAt])
}
